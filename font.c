#include "font.h"
#include <string.h>

const uint8_t alphabet[] PROGMEM =
{
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b01011111,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000111,
  0b00000000,
  0b00000111,
  0b00000000,
  0b00000000,
  0b00101000,
  0b01111100,
  0b00101000,
  0b01111100,
  0b00101000,
  0b00000000,
  0b00000100,
  0b00101010,
  0b01111111,
  0b00101010,
  0b00010000,
  0b00000000,
  0b00100010,
  0b00010000,
  0b00001000,
  0b00000100,
  0b00100010,
  0b00000000,
  0b00110000,
  0b01001010,
  0b01001101,
  0b00110010,
  0b01001000,
  0b00000000,
  0b00000000,
  0b00001011,
  0b00000111,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00011000,
  0b00100100,
  0b01000010,
  0b00000000,
  0b00000000,
  0b00000000,
  0b01000010,
  0b00100100,
  0b00011000,
  0b00000000,
  0b00000000,
  0b00101010,
  0b00011100,
  0b01111111,
  0b00011100,
  0b00101010,
  0b00000000,
  0b00001000,
  0b00001000,
  0b00111110,
  0b00001000,
  0b00001000,
  0b00000000,
  0b00000000,
  0b10110000,
  0b01110000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00001000,
  0b00001000,
  0b00001000,
  0b00001000,
  0b00001000,
  0b00000000,
  0b00000000,
  0b01100000,
  0b01100000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00100000,
  0b00010000,
  0b00001000,
  0b00000100,
  0b00000010,
  0b00000000,
  0b00111110,
  0b01010001,
  0b01001001,
  0b01000101,
  0b00111110,
  0b00000000,
  0b00000000,
  0b01000010,
  0b01111111,
  0b01000000,
  0b00000000,
  0b00000000,
  0b01100010,
  0b01010001,
  0b01001001,
  0b01001001,
  0b01000110,
  0b00000000,
  0b00100010,
  0b01000001,
  0b01001001,
  0b01001001,
  0b00110110,
  0b00000000,
  0b00001111,
  0b00001000,
  0b00001000,
  0b01111111,
  0b00001000,
  0b00000000,
  0b00101111,
  0b01001001,
  0b01001001,
  0b01001001,
  0b00110001,
  0b00000000,
  0b00111100,
  0b01001010,
  0b01001001,
  0b01001001,
  0b00110000,
  0b00000000,
  0b00000001,
  0b01110001,
  0b00001001,
  0b00000101,
  0b00000011,
  0b00000000,
  0b00110110,
  0b01001001,
  0b01001001,
  0b01001001,
  0b00110110,
  0b00000000,
  0b00000110,
  0b01001001,
  0b01001001,
  0b00101001,
  0b00011110,
  0b00000000,
  0b00000000,
  0b00110110,
  0b00110110,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b10110110,
  0b01110110,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00001000,
  0b00010100,
  0b00100010,
  0b01000001,
  0b00000000,
  0b00000000,
  0b00100100,
  0b00100100,
  0b00100100,
  0b00100100,
  0b00100100,
  0b00000000,
  0b00000000,
  0b01000001,
  0b00100010,
  0b00010100,
  0b00001000,
  0b00000000,
  0b00000010,
  0b00000001,
  0b01011001,
  0b00001001,
  0b00000110,
  0b00000000,
  0b00111110,
  0b01000001,
  0b01011101,
  0b01010001,
  0b00001110,
  0b00000000,
  0b01111110,
  0b00001001,
  0b00001001,
  0b00001001,
  0b01111110,
  0b00000000,
  0b01111111,
  0b01001001,
  0b01001001,
  0b01001001,
  0b00110110,
  0b00000000,
  0b00111110,
  0b01000001,
  0b01000001,
  0b01000001,
  0b00100010,
  0b00000000,
  0b01111111,
  0b01000001,
  0b01000001,
  0b00100010,
  0b00011100,
  0b00000000,
  0b01111111,
  0b01001001,
  0b01001001,
  0b01001001,
  0b01000001,
  0b00000000,
  0b01111111,
  0b00001001,
  0b00001001,
  0b00001001,
  0b00000001,
  0b00000000,
  0b00111110,
  0b01000001,
  0b01000001,
  0b01001001,
  0b01111010,
  0b00000000,
  0b01111111,
  0b00001000,
  0b00001000,
  0b00001000,
  0b01111111,
  0b00000000,
  0b00000000,
  0b01000001,
  0b01111111,
  0b01000001,
  0b00000000,
  0b00000000,
  0b00110000,
  0b01000000,
  0b01000000,
  0b01000000,
  0b00111111,
  0b00000000,
  0b01111111,
  0b00001000,
  0b00010100,
  0b00100010,
  0b01000001,
  0b00000000,
  0b01111111,
  0b01000000,
  0b01000000,
  0b01000000,
  0b01000000,
  0b00000000,
  0b01111111,
  0b00000110,
  0b00001100,
  0b00000110,
  0b01111111,
  0b00000000,
  0b01111111,
  0b00000010,
  0b00000100,
  0b00001000,
  0b01111111,
  0b00000000,
  0b00111110,
  0b01000001,
  0b01000001,
  0b01000001,
  0b00111110,
  0b00000000,
  0b01111111,
  0b00001001,
  0b00001001,
  0b00001001,
  0b00000110,
  0b00000000,
  0b00111110,
  0b01000001,
  0b01010001,
  0b00100001,
  0b01011110,
  0b00000000,
  0b01111111,
  0b00001001,
  0b00011001,
  0b00101001,
  0b01000110,
  0b00000000,
  0b00100110,
  0b01001001,
  0b01001001,
  0b01001001,
  0b00110010,
  0b00000000,
  0b00000001,
  0b00000001,
  0b01111111,
  0b00000001,
  0b00000001,
  0b00000000,
  0b00111111,
  0b01000000,
  0b01000000,
  0b01000000,
  0b00111111,
  0b00000000,
  0b00000111,
  0b00011000,
  0b01100000,
  0b00011000,
  0b00000111,
  0b00000000,
  0b01111111,
  0b00110000,
  0b00011000,
  0b00110000,
  0b01111111,
  0b00000000,
  0b01100011,
  0b00010100,
  0b00001000,
  0b00010100,
  0b01100011,
  0b00000000,
  0b00000111,
  0b00001000,
  0b01110000,
  0b00001000,
  0b00000111,
  0b00000000,
  0b01100001,
  0b01010001,
  0b01001001,
  0b01000101,
  0b01000011,
  0b00000000,
  0b00000000,
  0b01111111,
  0b01000001,
  0b01000001,
  0b00000000,
  0b00000000,
  0b00000010,
  0b00000100,
  0b00001000,
  0b00010000,
  0b00100000,
  0b00000000,
  0b00000000,
  0b01000001,
  0b01000001,
  0b01111111,
  0b00000000,
  0b00000000,
  0b00000100,
  0b00000010,
  0b00000001,
  0b00000010,
  0b00000100,
  0b00000000,
  0b01000000,
  0b01000000,
  0b01000000,
  0b01000000,
  0b01000000,
  0b00000000,
  0b00000000,
  0b00000011,
  0b00000100,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00100000,
  0b01010100,
  0b01010100,
  0b01010100,
  0b01111000,
  0b00000000,
  0b01111111,
  0b01001000,
  0b01000100,
  0b01000100,
  0b00111000,
  0b00000000,
  0b00111000,
  0b01000100,
  0b01000100,
  0b01000100,
  0b01001000,
  0b00000000,
  0b00111000,
  0b01000100,
  0b01000100,
  0b01000100,
  0b01111111,
  0b00000000,
  0b00111000,
  0b01010100,
  0b01010100,
  0b01010100,
  0b00011000,
  0b00000000,
  0b00001000,
  0b01111110,
  0b00001001,
  0b00000001,
  0b00000010,
  0b00000000,
  0b00011000,
  0b10100100,
  0b10100100,
  0b10100100,
  0b01111100,
  0b00000000,
  0b01111111,
  0b00001000,
  0b00000100,
  0b00000100,
  0b01111000,
  0b00000000,
  0b00000000,
  0b01000100,
  0b01111101,
  0b01000000,
  0b00000000,
  0b00000000,
  0b01000000,
  0b10000000,
  0b10000100,
  0b01111101,
  0b00000000,
  0b00000000,
  0b01111111,
  0b00010000,
  0b00101000,
  0b01000100,
  0b00000000,
  0b00000000,
  0b00000000,
  0b01000001,
  0b01111111,
  0b01000000,
  0b00000000,
  0b00000000,
  0b01111100,
  0b00000100,
  0b01111000,
  0b00000100,
  0b01111000,
  0b00000000,
  0b01111100,
  0b00000100,
  0b00000100,
  0b00000100,
  0b01111000,
  0b00000000,
  0b00111000,
  0b01000100,
  0b01000100,
  0b01000100,
  0b00111000,
  0b00000000,
  0b11111100,
  0b00100100,
  0b00100100,
  0b00100100,
  0b00011000,
  0b00000000,
  0b00011000,
  0b00100100,
  0b00100100,
  0b00100100,
  0b11111100,
  0b00000000,
  0b01111100,
  0b00001000,
  0b00000100,
  0b00000100,
  0b00001000,
  0b00000000,
  0b00001000,
  0b01010100,
  0b01010100,
  0b01010100,
  0b00100000,
  0b00000000,
  0b00000100,
  0b00111110,
  0b01000100,
  0b01000100,
  0b00000000,
  0b00000000,
  0b00111100,
  0b01000000,
  0b01000000,
  0b01000000,
  0b00111100,
  0b00000000,
  0b00011100,
  0b00100000,
  0b01000000,
  0b00100000,
  0b00011100,
  0b00000000,
  0b00111100,
  0b01000000,
  0b00111000,
  0b01000000,
  0b00111100,
  0b00000000,
  0b01000100,
  0b00101000,
  0b00010000,
  0b00101000,
  0b01000100,
  0b00000000,
  0b10011100,
  0b10100000,
  0b10100000,
  0b10100000,
  0b01111100,
  0b00000000,
  0b01000100,
  0b01100100,
  0b01010100,
  0b01001100,
  0b01000100,
  0b00000000,
  0b00001000,
  0b00110110,
  0b01000001,
  0b01000001,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b01111111,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b01000001,
  0b01000001,
  0b00110110,
  0b00001000,
  0b00000000,
  0b00000100,
  0b00000010,
  0b00000100,
  0b00001000,
  0b00000100,
  0b00000000
};

extern void Sleep(uint16_t kiloclocks);
extern volatile uint8_t fb_base;
extern volatile uint16_t framebuf[16];

#define BUTTON_LEFT  0x01
#define BUTTON_RIGHT 0x02
#define BUTTON_HOLD  0x10 	// button was held

uint8_t GetButtons(void);

volatile uint16_t delay = MILLIS(40);

void scroll_char(char c, uint8_t color)
{
	uint8_t buttons;
	uint16_t base = ((uint16_t)c - 32) * 6;
	for(uint8_t i = 0; i < 6; ++i)
	{
		uint8_t b = pgm_read_byte_near(alphabet + base + i);
		uint8_t n = (fb_base + 8) & 0x0F;
		uint16_t c = 0;
		uint8_t j;
		for(j = 0x80; j != 0; j >>= 1)
		{
			c <<= 2;
			if (b & j)
				c |= color;
		}
		framebuf[n] = c;
		fb_base = (fb_base + 1) & 0x0F;
		Sleep(delay);
		buttons = GetButtons();
		if ((buttons & BUTTON_LEFT) && (delay < MILLIS(200)))
			delay += MILLIS(8);
		else if ((buttons & BUTTON_RIGHT) && (delay > MILLIS(10)))
			delay -= MILLIS(8);
	}
}

void DrawTextP(const char *text, uint8_t color)
{
	int i = 0;
	for(;;)
	{
		uint8_t c = pgm_read_byte_near(text + i);
		if (c == 0)
			break;
		scroll_char((char)c, color);
		++i;
	}
}

void DrawText(const char *text, uint8_t color)
{
	while(*text)
		scroll_char(*text++, color);
}

